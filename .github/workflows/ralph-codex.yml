name: Ralph + Codex Task Loop

on:
  workflow_dispatch:
    inputs:
      task:
        description: "Task to execute"
        required: true
        type: string
      run_e2e:
        description: "Run Playwright e2e"
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  agent-loop:
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: file:./dev.db
      FITBIT_CLIENT_ID: test_client_id
      FITBIT_CLIENT_SECRET: test_client_secret
      FITBIT_REDIRECT_URI: http://localhost:3000/api/auth/fitbit/callback
      SYNC_CRON_SECRET: test_sync_secret
      AUTO_SYNC_DAYS: "3"
      NEXT_TELEMETRY_DISABLED: "1"
      TASK: ${{ inputs.task }}
      RALPH_CMD: ${{ vars.RALPH_CMD || secrets.RALPH_CMD }}
      CODEX_CMD: ${{ vars.CODEX_CMD || secrets.CODEX_CMD }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      RALPH_API_KEY: ${{ secrets.RALPH_API_KEY }}
      BOT_GH_TOKEN: ${{ secrets.BOT_GH_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install
        run: npm ci

      - name: Install Codex CLI
        run: npm install -g @openai/codex

      - name: Validate OpenAI API Key
        run: |
          OPENAI_API_KEY="$(printf "%s" "${OPENAI_API_KEY:-}" | tr -d '\r' | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')"
          if [[ -z "${OPENAI_API_KEY:-}" ]]; then
            echo "::error::OPENAI_API_KEY is empty. Set it in Actions secrets (or variable)."
            exit 1
          fi
          if [[ "${OPENAI_API_KEY:0:3}" != "sk-" ]]; then
            echo "::error::OPENAI_API_KEY format invalid (expected sk- prefix)."
            exit 1
          fi
          HTTP_CODE="$(curl -sS -o /tmp/openai-auth.json -w "%{http_code}" \
            https://api.openai.com/v1/models \
            -H "Authorization: Bearer ${OPENAI_API_KEY}")"
          if [[ "$HTTP_CODE" != "200" ]]; then
            echo "::error::OpenAI key validation failed (HTTP $HTTP_CODE)."
            sed -n '1,120p' /tmp/openai-auth.json || true
            exit 1
          fi
          echo "OpenAI key validation passed."

      - name: Configure Codex API-key Auth
        run: |
          mkdir -p "$HOME/.codex"
          cat > "$HOME/.codex/auth.json" <<JSON
          {"OPENAI_API_KEY":"${OPENAI_API_KEY}"}
          JSON
          cat > "$HOME/.codex/config.toml" <<'TOML'
          preferred_auth_method = "apikey"
          TOML
          echo "Codex auth profile configured for API key mode."

      - name: Prisma Generate
        run: npx prisma generate

      - name: Prisma Migrate Deploy
        run: npx prisma migrate deploy

      - name: Run Ralph Planning
        continue-on-error: true
        run: |
          TASK_TRIMMED="$(echo "$TASK" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')"
          chmod +x scripts/agent/run-ralph.sh
          scripts/agent/run-ralph.sh "$TASK_TRIMMED"

      - name: Show Ralph Plan
        if: always()
        run: |
          echo "----- docs/agent-plan.md -----"
          sed -n '1,200p' docs/agent-plan.md || true

      - name: Run Codex Implementation
        run: |
          TASK_TRIMMED="$(echo "$TASK" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')"
          chmod +x scripts/agent/run-codex.sh
          scripts/agent/run-codex.sh "$TASK_TRIMMED"

      - name: Show Codex Summary
        if: always()
        run: |
          echo "----- docs/codex-summary.md -----"
          sed -n '1,220p' docs/codex-summary.md || true

      - name: Resolve Fallback Label
        id: fallback_label
        if: always()
        run: |
          if [[ -f docs/codex-fallback.status ]]; then
            VALUE="$(cat docs/codex-fallback.status | tr -d '\r\n ')"
            if [[ "$VALUE" == "quota" ]]; then
              echo "label=blocked:quota" >> "$GITHUB_OUTPUT"
            elif [[ "$VALUE" == "auth" ]]; then
              echo "label=blocked:auth" >> "$GITHUB_OUTPUT"
            else
              echo "label=automation" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "label=automation" >> "$GITHUB_OUTPUT"
          fi

      - name: Append task log
        run: |
          {
            echo "## $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            echo "Task: $TASK"
            echo "Workflow: $GITHUB_WORKFLOW"
            echo "Run: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
            echo
          } >> docs/agent-log.md

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

      - name: Unit Tests
        run: npm run test:unit

      - name: Install Playwright Browser
        if: inputs.run_e2e
        run: npx playwright install --with-deps chromium

      - name: E2E Tests
        if: inputs.run_e2e
        run: npm run test:e2e

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v7
        continue-on-error: true
        with:
          token: ${{ secrets.BOT_GH_TOKEN || github.token }}
          base: main
          branch: agent/${{ github.run_id }}
          title: "agent: ${{ inputs.task }}"
          body: |
            ## Ralph + Codex Automated Task

            **Task**: `${{ inputs.task }}`

            Generated by workflow `${{ github.workflow }}`.
            - Plan: `docs/agent-plan.md`
            - Execution: `docs/codex-summary.md`
            - Log: `docs/agent-log.md`
          commit-message: "chore(agent): ${{ inputs.task }}"
          labels: |
            automation
            ${{ steps.fallback_label.outputs.label }}

      - name: PR Result
        if: always()
        run: |
          PR_URL="https://github.com/${GITHUB_REPOSITORY}/pull/new/agent/${GITHUB_RUN_ID}"
          if [[ "${{ steps.cpr.outcome }}" == "success" ]]; then
            echo "Pull request created/updated successfully."
            exit 0
          fi

          echo "::warning::Automatic PR creation failed."
          echo "Manual PR URL: ${PR_URL}"
          echo
          echo "If this keeps happening, configure BOT_GH_TOKEN with:"
          echo "- Classic PAT: repo scope"
          echo "- Fine-grained PAT: Contents (Read/Write), Pull requests (Read/Write) on this repo"
          echo "Continuing without failing workflow."
          exit 0
